<link href="__ADMIN_STATIC__/Widget/icheck/icheck.css" rel="stylesheet" type="text/css" />
<link href="__ADMIN_STATIC__/Widget/webuploader/0.1.5/webuploader.css" rel="stylesheet" type="text/css" />

<title>新增图片</title>
</head>

<body>
  <style>
  .delete-img {
    position: absolute;
    left: 0;
    top: 0;
    display: block;
    text-align: center;
    width: 100%;
    background: rgba(0, 0, 0, 0.4);
    color: #fff;
    cursor: pointer;
    height: 28px;
    line-height: 28px;
  }

  .btn-success {
    color: #fff;
    background-color: #449d44;
    border-color: #398439;
  }

  .btn {
    display: inline-block;
    padding: 6px 12px;
    margin-bottom: 0;
    font-size: 14px;
    font-weight: 400;
    line-height: 1.42857143;
    text-align: center;
    white-space: nowrap;
    vertical-align: middle;
    -ms-touch-action: manipulation;
    touch-action: manipulation;
    cursor: pointer;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
    background-image: none;
    border: 1px solid transparent;
    border-radius: 4px;
  }
  .input-tips{
    color: #999;
    font-size:12px;
    display: block;
  }
  .input-tips:hover{
    color: #00C1B3;
  }
  #form-article-add .cl .Add_p_s .input-text,
  #form-article-add .cl .Add_p_s .select{
    width: 76%;
    margin-right: 5px;
  }


  </style>
  <div class="clearfix" id="add_picture">
    <div class="page_right_style" style="left:0">
      <div class="type_title">添加商品</div>
      <form action="{:url('add')}" method="post" class="form form-horizontal" id="form-article-add">
        <!--商品的基本信息-->
        <div class="panel panel-default" style="margin-left:35px;margin-right:35px;">
          <div class="panel-heading">商品基本信息</div>
          <div class="panel-body">
            <div class="clearfix cl">
              <label class="form-label col-2"><span class="c-red">*</span>标题：</label>
              <div class="formControls col-10">
                <input type="text" name="title" class="input-text" value="{$goods.title|default=''}" datatype="*5-100" nullmsg="标题不能空！" errormsg="标题5-200字符" placeholder="" id="title" />
                <span class="input-tips">小于200个字符，100个汉字</span>
              </div>
            </div>
            <div class="clearfix cl">
              <label class="form-label col-2"><span class="c-red">*</span>商品缩略图：</label>
              <div class="demo l_f">
                <div class="logobox">
                  <div class="resizebox" id="upload" onclick="document.getElementById('brandLogo').click()" style="position:relative"><img src="{if condition="isset($goods) && ($goods['thumb'] neq '')"}{$goods.thumb}{else/}/thems/admin/static/images/image.png{/if}" width="100px" alt="" height="100px"><i class="delete-img" data-src="{if condition="isset($goods) && ($goods['thumb'] neq '')"}{$goods.thumb}{else/}/thems/admin/static/images/image.png{/if}">删除</i></div>
                </div>
                <div class="logoupload">
                  <div class="btnbox"><a id="uploadBtnHolder" class="uploadbtn" href="javascript:;" onclick="document.getElementById('brandLogo').click()">上传替换</a></div>
                </div>
                <input type="hidden" name="thumb" value="{$goods.thumb|default=''}" datatype="*" nullmsg="没有上传缩略图" id="logo" data-role="add">
                <input type="file" name="brandLogo" id="brandLogo" onchange="fileSelect()" hidden style="display:none">
              </div>
            </div>
            <div class="clearfix cl">
              <label class="form-label col-2">关键词：</label>
              <div class="formControls col-10">
                <input type="text" class="input-text" value="{$goods.keywords|default=''}" placeholder="" id="keywords" name="keywords" />
                <span class="input-tips">多个用英文输入法的,分隔，小于100个字符</span>
              </div>
            </div>
            <div class="clearfix cl">
              <label class="form-label col-2">内容摘要：</label>
              <div class="formControls col-10">
                <textarea name="description" cols="" rows="" class="textarea" placeholder=""  dragonfly="true">{$goods.description|default=''}</textarea></p>
              </div>
            </div>
            <div class="clearfix cl">
              <label class="form-label col-2">商品分类：</label>
              <div class="formControls col-8" style="width: 300px;">
                <select name="cat_id" style="width: 300px;" datatype="*" nullmsg="还没有选择商品分类">
                  <option value="">选择商品分类</option>
                  {volist name="cate_list" id="c"}
                    <option value="{$c.id}" {if condition="isset($goods)"}{eq name="goods['cat_id']" value="$c['id']"}selected="selected"{/eq}{/if}>{neq name="c.level" value="1"}|{php}for($i=1;$i<$c['level'];$i++){echo '--';}{/php}{/neq}{$c.name}</option>
                  {/volist}
                </select>
              </div>
            </div>
            <div class="clearfix cl">
              <div class="Add_p_s">
                <label class="form-label col-2">商品货号：</label>
                <div class="formControls col-2">
                  <input type="text" class="input-text" value="{$goods.artnum|default=''}" placeholder="" id="artnum" name="artnum">
                  <span class="input-tips">不填会自动生成</span>
                </div>
              </div>
              <div class="Add_p_s">
                <label class="form-label col-2">品&nbsp;&nbsp;&nbsp;&nbsp;牌：</label>
                <div class="formControls col-2">
                  <select class="input-text" datatype="*" nullmsg="没有选择品牌！" name="brand">
                    <option value="">请选择品牌</option>
                    {volist name="brand_list" id="bl"}
                      <option value="{$bl.id}" {if condition="isset($goods)"}{eq name="goods['brand']" value="$bl['id']"}selected="selected"{/eq}{/if}>{$bl.name}</option>
                    {/volist}
                  </select>
                </div>
              </div>
              <div class="Add_p_s">
                <label class="form-label col-2">商品重量：</label>
                <div class="formControls col-2">
                  <input type="text" class="input-text" value="{$goods.weight|default=''}" datatype="f" nullmsg="重量没有填写！" errormsg="重量格式错误" placeholder="" id="weight" name="weight"><span class="input-tips">单位:kg(最多两位小数)</span></div>
              </div>
              <div class="Add_p_s">
                <label class="form-label col-2">单位：</label>
                <div class="formControls col-2">
                  <span class="select-box">
                    <select class="select" nullmsg="选择单位！" name="unit" datatype="*" name="unit">
                        <option value="">请选择</option>
                        <option value="1" {if condition="isset($goods)"}{eq name="goods['unit']" value="1"}selected="selected"{/eq}{/if}>件</option>
                        <option value="2" {if condition="isset($goods)"}{eq name="goods['unit']" value="2"}selected="selected"{/eq}{/if}>斤</option>
                        <option value="3" {if condition="isset($goods)"}{eq name="goods['unit']" value="3"}selected="selected"{/eq}{/if}>KG</option>
                        <option value="4" {if condition="isset($goods)"}{eq name="goods['unit']" value="4"}selected="selected"{/eq}{/if}>吨</option>
                        <option value="5" {if condition="isset($goods)"}{eq name="goods['unit']" value="5"}selected="selected"{/eq}{/if}>套</option>
                    </select>
                  </span>
                </div>
              </div>
            </div>
            <div class="clearfix cl">
              <div class="Add_p_s">
                <label class="form-label col-2">市场价格：</label>
                <div class="formControls col-2">
                  <input type="text" name="mkt_price" datatype="f" errormsg="价格格式错误" nullmsg="市场价格没有填写！" value="{$goods.mkt_price|default=''}" class="input-text" placeholder="市场价格" />
                  <span class="input-tips">最多两位小数</span>
                </div>
              </div>
              <div class="Add_p_s">
                <label class="form-label col-2">本店价格：</label>
                <div class="formControls col-2">
                  <input type="text" name="shop_price" value="{$goods.shop_price|default=''}" datatype="f" errormsg="价格格式错误" nullmsg="本店价格没有填写！" class="input-text" placeholder="市场价格" />
                  <span class="input-tips">最多两位小数</span>
                </div>
              </div>
              <div class="Add_p_s">
                <label class="form-label col-2">库存：</label>
                <div class="formControls col-2">
                  <input type="text" name="store_count" value="{$goods.store_count|default=''}" datatype="n" errormsg="价格格式错误" nullmsg="本店价格没有填写！" class="input-text" placeholder="库存" />
                  <span class="input-tips">只能填写数字</span>
                </div>
              </div>
              <div class="Add_p_s">
                <label class="form-label col-2">利润：</label>
                <div class="formControls col-2">
                  <input type="text" name="store_profit" value="{$goods.store_profit|default=''}" datatype="f" errormsg="格式错误" nullmsg="本店利润没有填写！" class="input-text" placeholder="利润" />
                  <span class="input-tips">需填写确切的利润用于分成</span>
                </div>
              </div>
            </div>
            <div class=" clearfix cl" style="font-size:12px">
              <div class="Add_p_s" >
                <label class="form-label col-2">代理商分成比例:</label>
                <div class="formControls col-2">
                  <input type="text" class="input-text" value="{$goods['agent_config'][1]|default='0'}" placeholder="" datatype="f" errormsg="数据填写错误" name='agent[1]'>%<span class="input-tips">最多两位小数</span></div>
              </div>
              <div class="Add_p_s">
                <label class="form-label col-1">经销商分成比例：</label>
                <div class="formControls col-1">
                  <input type="text" class="input-text"  value="{$goods['agent_config'][2]|default='0'}" placeholder="" datatype="f" errormsg="数据格式填写错误" name="agent[2]">%<span class="input-tips">最多两位小数</span></div>
              </div>
              <div class="Add_p_s">
                <label class="form-label col-2">VIP用户分成：</label>
                <div class="formControls col-2">
                  <input type="text" class="input-text"  value="{$goods['agent_config'][3]|default='0'}" placeholder="" datatype="f" errormsg="数据格式填写错误" name="agent[3]">%<span class="input-tips">最多两位小数</span></div>
              </div>
              <!--<div class="Add_p_s">
                <label class="form-label col-2">经销商分成：</label>
                <div class="formControls col-2">
                  <input type="text" class="input-text"  value="{$goods['agent_config'][4]|default='0'}" placeholder="" datatype="f" errormsg="数据格式填写错误" id="" name="agent[4]">元<span class="input-tips">最多两位小数</span></div>
              </div>-->
              <div class="Add_p_s">
                <label class="form-label col-2">赠送积分：</label>
                <div class="formControls col-2">
                  <input type="text" class="input-text" value="{$goods.give_integral|default='0'}" placeholder="" datatype="n" errmsg="只能是数字" id="give_integral" name="give_integral">元<span class="input-tips">只能是整数</span></div>
              </div>
            </div>
          </div>
        </div>
        <!--商品模型-->
        <div class="panel panel-default" style="margin-left:35px;margin-right:35px;">
          <div class="panel-heading">商品模型</div>
          <div class="panel-body">
            <div class="ncap-form-default tab_div_3" style="">
              <dl class="row">
                <div class="tab-pane" id="tab_goods_spec">
                  <table class="table table-bordered" id="goods_spec_table">
                    <tbody>
                      <tr>
                        <td>商品模型:</td>
                        <td>
                          <select name="goods_type" id="spec_type" datatype="*" nullmsg="商品模型不能为空" class="form-control" style="width:250px;">
                            <option value="0">选择商品模型</option>
                            {volist name="goodsModel" id="gm"}
                            <option value="{$gm.id}" {if condition="isset($goods)"}{eq name="goods['goods_type']" value="$gm['id']"}selected="selected"{/eq}{/if}>{$gm.name}</option>
                            {/volist}
                          </select>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                  <div class="row">
                    <!-- ajax 返回规格-->
                    <div id="ajax_spec_data" class="col-xs-8">
                      <table class="table table-bordered" id="goods_spec_table1">
                      </table>
                      <div id="goods_spec_table2">
                        <table class="table table-bordered" id="spec_input_tab">
                        </table>
                      </div>
                    </div>
                    <div id="" class="col-xs-4">
                      <table class="table table-bordered" id="goods_attr_table">
                        <tbody>
                          <tr>
                            <td><b>商品属性</b>：</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </dl>
            </div>
          </div>
        </div>

        <!--商品条件的设置-->
        <div class="panel panel-default" style="margin-left:35px;margin-right:35px;">
          <div class="panel-heading">商品条件设置</div>
          <div class="panel-body">
            <div class="clearfix cl">
              <label class="form-label col-2">是否是实物：</label>
              <div class="formControls col-2 skin-minimal">
                <div class="check-box" style=" margin-top:9px">
                  <input type="checkbox" {if condition="isset($goods)"}{eq name="goods['is_real']" value="1"}checked{/eq}{/if} id="checkbox-1" name="is_real">
                  <label for="checkbox-1">&nbsp;</label>
                </div>
              </div>
              <label class="form-label col-2">是否上架：</label>
              <div class="formControls col-2 skin-minimal">
                <div class="check-box" style=" margin-top:9px">
                  <input type="checkbox" {if condition="isset($goods)"}{eq name="goods['is_on_sale']" value="1"}checked{/eq}{/if} id="checkbox-2" name="is_on_sale">
                  <label for="checkbox-1">&nbsp;</label>
                </div>
              </div>
              <label class="form-label col-2">是否推荐：</label>
              <div class="formControls col-2 skin-minimal">
                <div class="check-box" style=" margin-top:9px">
                  <input type="checkbox" {if condition="isset($goods)"}{eq name="goods['is_recommend']" value="1"}checked{/eq}{/if} id="checkbox-3" name="is_recommend">
                  <label for="checkbox-1">&nbsp;</label>
                </div>
              </div>
              <label class="form-label col-2">是否新品：</label>
              <div class="formControls col-2 skin-minimal">
                <div class="check-box" style=" margin-top:9px">
                  <input type="checkbox" {if condition="isset($goods)"}{eq name="goods['is_new']" value="1"}checked{/eq}{/if} id="checkbox-4" name="is_new">
                  <label for="checkbox-1">&nbsp;</label>
                </div>
              </div>
              <label class="form-label col-2">是否热卖：</label>
              <div class="formControls col-2 skin-minimal">
                <div class="check-box" style=" margin-top:9px">
                  <input type="checkbox" {if condition="isset($goods)"}{eq name="goods['is_hot']" value="1"}checked{/eq}{/if} id="checkbox-5" name="is_hot">
                  <label for="checkbox-1">&nbsp;</label>
                </div>
              </div>
            </div>
            <div class="clearfix cl">
              <label class="form-label col-2">排序：</label>
              <div class="formControls col-10">
                <input type="text" class="input-text" value="{$goods['sort']|default=''}" placeholder="" id="sort" name="sort">
              </div>
            </div>
          </div>
        </div>
        <!--商品详细内容设置-->
        <div class="panel panel-default" style="margin-left:35px;margin-right:35px;">
          <div class="panel-heading">商品详细内容设置</div>
          <div class="panel-body">
        <div class="clearfix cl">
          <label class="form-label col-2">轮播图片上传：</label>
          <div class="formControls col-10">
            <div class="uploader-list-container">
              <div class="queueList">
                <div id="dndArea" class="placeholder   {if condition="isset($goodsImg)"}{neq name="goodsImg" value=""}element-invisible{/neq}{/if}">
                  <div id="filePicker-2"></div>
                  <p>或将照片拖到这里，单次最多可选300张</p>
                </div>
                {if condition="isset($goodsImg)"}{neq name="goodsImg" value=""}
                  <ul class="filelist">
                    {volist name="goodsImg" id="gimg" key="k"}
                    <li id="WU_FILE_{$k}"><p class="title">{$gimg.image_url}</p><p class="imgWrap"><img src="{$gimg.image_url}" style="height:100%; width:100%;"></p><div class="file-panel" style="height: 30px;"><span class="delete-img cancel" data-id="{$gimg.id}" style="left:50%;margin-left:-12px;" data-src="{$gimg.image_url}">删除</span></div></li>
                    {/volist}
                  </ul>
                {/neq}{/if}
              </div>
              <div class="statusBar" style="{if condition="isset($goodsImg)"}{neq name="goodsImg" value=""}{else/}display:none;{/neq}{/if}">
                <div class="progress"> <span class="text">0%</span> <span class="percentage"></span> </div>
                <div class="info"></div>
                <div class="btns">
                  <div id="filePicker2"></div>
                  <div class="uploadBtn">开始上传</div>
                </div>
              </div>
                {if condition="isset($goodsImg)"}{neq name="goodsImg" value="gimg"}
                <ul class="filelist">
                  {volist name="goodsImg" id="gimg" key="k"}
                  <input type="hidden" value="{$gimg.image_url}" id="img_{$k}" name="goods_images[]">
                  {/volist}
                </ul>
              {/neq}{/if}
            </div>
          </div>
        </div>
        <div class="clearfix cl">
          <label class="form-label col-2">详细内容：</label>
          <div class="formControls col-10">
            <textarea id="editor" name="goods_details" type="text/plain" style="width:100%;height:400px;">{$goode_details.details|default=''}</textarea>
          </div>
        </div>
      </div>
        {if condition="isset($goodsImg)"}{neq name="goods['id']" value=""}
      <input type="hidden" name="goods_id" value="{$goods.id}" />{/neq}{/if}
        <div class="clearfix cl">
          <div class="Button_operation">
            <button class="btn btn-primary radius" id="submitForm" type="button"><i class="icon-save "></i>保存并提交审核</button>
            <button onClick="article_save();" class="btn btn-secondary  btn-warning" type="button"><i class="icon-save"></i>保存草稿</button>
            <button id="restForm" class="btn btn-default radius" type="button">&nbsp;&nbsp;重置&nbsp;&nbsp;</button>
          </div>
        </div>
        </div>

      </form>
    </div>
  </div>
  </div>
  <script src="__ADMIN_STATIC__/js/jquery-1.9.1.min.js"></script>
  <script src="__ADMIN_STATIC__/assets/js/bootstrap.min.js"></script>
  <script src="__ADMIN_STATIC__/assets/js/typeahead-bs2.min.js"></script>
  <script type="text/javascript" src="__ADMIN_STATIC__/Widget/My97DatePicker/WdatePicker.js"></script>
  <script type="text/javascript" src="__ADMIN_STATIC__/Widget/icheck/jquery.icheck.min.js"></script>
  <script type="text/javascript" src="__ADMIN_STATIC__/Widget/zTree/js/jquery.ztree.all-3.5.min.js"></script>
  <script type="text/javascript" src="__ADMIN_STATIC__/Widget/Validform/5.3.2/Validform.min.js"></script>
  <script type="text/javascript" src="__ADMIN_STATIC__/Widget/webuploader/0.1.5/webuploader.min.js"></script>
  <script type="text/javascript" src="__ADMIN_STATIC__/Widget/ueditor/1.4.3/ueditor.config.js"></script>
  <script type="text/javascript" src="__ADMIN_STATIC__/Widget/ueditor/1.4.3/ueditor.all.min.js"> </script>
  <script type="text/javascript" src="__ADMIN_STATIC__/Widget/ueditor/1.4.3/lang/zh-cn/zh-cn.js"></script>
  <script src="__ADMIN_STATIC__/js/lrtk.js" type="text/javascript"></script>
  <script type="text/javascript" src="__ADMIN_STATIC__/js/H-ui.js"></script>
  <script type="text/javascript" src="__ADMIN_STATIC__/js/ajaxfileupload.js"></script>
  <script>
  function fileSelect(o){
      // alert(1)
      // return false
      {if condition="isset($goodsImg)"}{neq name="goods['id']" value=""}
        util.ajaxGet('{:url("delGoodsImg",["id"=> $goods["id"]])}', '').done(function (res) {
          if(res.code > 0){
            alert(res.msg);
          }else{
            alert(res.msg+'，请手动删除');
          }
        });
      {/neq}
      {/if}
      $.ajaxFileUpload({
          url:'{:url('api/UploadFiles/uploadAjax',array('file'=>'brandLogo','to_dir'=>'goods'))}',
          type: 'post',
          secureuri :false,
          fileElementId :'brandLogo',
          dataType : 'json',
          success : function (res){
          if(res.code == 1){
              layer.msg('上传成功')
              $("#upload").find('img').eq(0).attr('src', res.path)
              $('.delete-img').data('src', res.path)
              $("#logo").val(res.path);
          }else{
              layer.msg('上传失败')
          }
      },
      error: function(data, status, e){   //提交失败自动执行的处理函数
          // alert('error',e);
          console.log(data)
          console.log(status)
          console.log(e)
      }
  })
  }
  $(function() {
    $("#add_picture").fix({
      float: 'left',
      skin: 'green',
      durationTime: false,
      stylewidth: '220',
      spacingw: 0,
      spacingh: 260,
    });
    $(".logobox .delete-img").on('click', function (e) {
          if($(this).data('src') !== undefined){
              util.ajaxPost('{:url('api/UploadFiles/delImg')}', {path: $(this).data('src')}).done(function (res) {
                  if(res.code == 1){
                      $("#upload").find('img').eq(0).attr('src', '')
                      $('.delete-img').data('src', '')
                      $("#logo").val('');
                      console.log(util.getUrlParms('id'))
                    {if condition="isset($goodsImg)"}{neq name="goods['id']" value=""}
                        util.ajaxGet('{:url("delGoodsImg",["id"=> $goods["id"]])}', '').done(function (res) {
                          if(res.code > 0){
                            alert(res.msg);
                          }else{
                            alert(res.msg+'，请手动删除');
                          }
                        });
                    {/neq}
                    {/if}
                  }
                  layer.msg(res.msg)
              }).fail(function (err) {
                  layer.msg(err.status + '服务器错误')
              });
          }
          return false;
      })
  });
  $(".queueList").click(function(evt){
    var target = evt.target;
    if($(target).hasClass('delete-img')){
      //删除图片
      if($(target).data('src') !== undefined){
          util.ajaxPost('{:url('api/UploadFiles/delImg')}', util.jsonToUrlStr({
            path: $(target).data('src'),
            table:'goods_images',
            id: $(target).data('id')
          })).done(function (res) {
              if(res.code == 1){
                  //成功
                  //取出input
                  $("#img_"+$(target).data('id')).remove();
                  $(target).parent().parent().remove();
              }
              layer.msg(res.msg)
          }).fail(function (err) {
              layer.msg(err.status + '服务器错误')
          });
      }
      return false;
    }
  })
  $(document).ready(function() {
    //初始化宽度、高度
    $(".widget-box").height($(window).height());
    $(".page_right_style").height($(window).height());
    $(".page_right_style").width($(window).width() - 220);
    //当文档窗口发生改变时 触发
    $(window).resize(function() {

      $(".widget-box").height($(window).height());
      $(".page_right_style").height($(window).height());
      $(".page_right_style").width($(window).width() - 220);
    });
  });
  $(function() {
    var ue = UE.getEditor('editor');
  });
  // 物流设置相 关
  function choosebox(o){
      var vt = $(o).is(':checked');
      if(vt){
          $('input[type=checkbox]').prop('checked',vt);
      }else{
          $('input[type=checkbox]').removeAttr('checked');
      }
  }
  </script>
  <script type="text/javascript">
  /** 以下 商品规格相关 js*/
  $(document).ready(function() {
    // 商品模型切换时 ajax 调用  返回不同的属性输入框
    $("#spec_type").change(function() {
      var goods_id = '{$goods.id|default="0"}';
      var spec_type = $(this).val() ? $(this).val() : 0;
      $.ajax({
        type: 'GET',
        data: {
            goods_id: goods_id,
            spec_type: spec_type
        },
        url: "{:url('admin/Goods/ajaxGetSpecSelect')}",
        success: function(data) {
          $("#ajax_spec_data").html('')
          $("#ajax_spec_data").append(data);
          ajaxGetSpecInput(); // 触发完  马上触发 规格输入框
        }
      });
      //商品类型切换时 ajax 调用  返回不同的属性输入框
      $.ajax({
        type: 'GET',
        data: {
          goods_id: goods_id,
          type_id: spec_type
        },
        url: "{:url('ajaxGetAttrInput')}",
        success: function(data) {
          $("#goods_attr_table tr:gt(0)").remove()
          $("#goods_attr_table").append(data);
        }
      });
    });
    // 触发商品规格
    $("#spec_type").trigger('change');

    $("input[name='exchange_integral']").blur(function() {
      var shop_price = parseInt($("input[name='shop_price']").val());
      var exchange_integral = parseInt($(this).val());
      if (shop_price * 100 < exchange_integral) {

      }
    });

    //物流
    $(":checkbox[cka]").click(function(){
        var $cks = $(":checkbox[ck='"+$(this).attr("cka")+"']");
        console.log($(this), $cks);
        if($(this).is(':checked')){
            $cks.each(function(){$(this).prop("checked",true);});
        }else{
            $cks.each(function(){$(this).removeAttr('checked');});
        }
    });
  });
  </script>
  <script>
    //表单验证
    $("#form-article-add").Validform({
        btnSubmit:"#submitForm", //#btn_sub是该表单下要绑定点击提交表单事件的按钮;如果form内含有submit按钮该参数可省略;
        btnReset:"#restForm",//可选项 .btn_reset是该表单下要绑定点击重置表单事件的按钮;
        tiptype: 3,
        ignoreHidden:false,//对:hidden的表单元素将不做验证;
        tipSweep:true,//可选项 true | false 默认为false，只在表单提交时触发检测，
        label:".label",//可选项 选择符，在没有绑定nullmsg时查找要显示的提示文字，默认查找".Validform_label"下的文字;
        showAllError:true,//可选项 true | false，true：提交表单时所有错误提示信息都会显示，false：一碰到验证不通过的就停止检测后面的元素，只显示该元素的错误信息;
        postonce:true, //可选项 表单是否只能提交一次，true开启，不填则默认关闭;
        ajaxPost:true, //使用ajax方式提交表单数据，默认false，提交地址就是action指定地址;
        datatype:{
          'f': /(^[1-9]\d*(\.\d{1,2})?$)|(^0(\.\d{1,2})?$)/
        },
        beforeSubmit:function(curform){
            //组装数据
            console.log(curform)
            // return false;
        },
        callback:function(data){
            console.log(data)
            if(data.code == 1){
              layer.msg(data.msg);
              setTimeout(()=>window.location.href=data.url, 2000);
            }else{
              layer.msg(data.msg)
            }
            //返回数据data是json格式，{"info":"demo info","status":"y"}
            //info: 输出提示信息;
            //status: 返回提交数据的状态,是否提交成功。如可以用"y"表示提交成功，"n"表示提交失败，在ajax_post.php文件返回数据里自定字符，主要用在callback函数里根据该值执行相应的回调操作;
            //你也可以在ajax_post.php文件返回更多信息在这里获取，进行相应操作；
            //ajax遇到服务端错误时也会执行回调，这时的data是{ status:**, statusText:**, readyState:**, responseText:** }；

            //这里执行回调操作;
            //注意：如果不是ajax方式提交表单，传入callback，这时data参数是当前表单对象，回调函数会在表单验证全部通过后执行，然后判断是否提交表单，如果callback里明确return false，则表单不会提交，如果return true或没有return，则会提交表单。
        }
    });
  </script>
  <script>
  (function ($) {
    // 当domReady的时候开始初始化
    $(function () {
      var $wrap = $('.uploader-list-container'),

        // 图片容器
        $queue = $('<ul class="filelist"></ul>')
        .appendTo($wrap.find('.queueList')),

        // 状态栏，包括进度和控制按钮
        $statusBar = $wrap.find('.statusBar'),

        // 文件总体选择信息。
        $info = $statusBar.find('.info'),

        // 上传按钮
        $upload = $wrap.find('.uploadBtn'),

        // 没选择文件之前的内容。
        $placeHolder = $wrap.find('.placeholder'),

        $progress = $statusBar.find('.progress').hide(),

        // 添加的文件数量
        fileCount = 0,

        // 添加的文件总大小
        fileSize = 0,

        // 优化retina, 在retina下这个值是2
        ratio = window.devicePixelRatio || 1,

        // 缩略图大小
        thumbnailWidth = 110 * ratio,
        thumbnailHeight = 110 * ratio,

        // 可能有pedding, ready, uploading, confirm, done.
        state = 'pedding',

        // 所有文件的进度信息，key为file id
        percentages = {},
        // 判断浏览器是否支持图片的base64
        isSupportBase64 = (function () {
          var data = new Image();
          var support = true;
          data.onload = data.onerror = function () {
            if (this.width != 1 || this.height != 1) {
              support = false;
            }
          }
          data.src = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";
          return support;
        })(),

        // 检测是否已经安装flash，检测flash的版本
        flashVersion = (function () {
          var version;

          try {
            version = navigator.plugins['Shockwave Flash'];
            version = version.description;
          } catch (ex) {
            try {
              version = new ActiveXObject('ShockwaveFlash.ShockwaveFlash')
                .GetVariable('$version');
            } catch (ex2) {
              version = '0.0';
            }
          }
          version = version.match(/\d+/g);
          return parseFloat(version[0] + '.' + version[1], 10);
        })(),

        supportTransition = (function () {
          var s = document.createElement('p').style,
            r = 'transition' in s ||
            'WebkitTransition' in s ||
            'MozTransition' in s ||
            'msTransition' in s ||
            'OTransition' in s;
          s = null;
          return r;
        })(),

        // WebUploader实例
        uploader;

      if (!WebUploader.Uploader.support('flash') && WebUploader.browser.ie) {

        // flash 安装了但是版本过低。
        if (flashVersion) {
          (function (container) {
            window['expressinstallcallback'] = function (state) {
              switch (state) {
                case 'Download.Cancelled':
                  alert('您取消了更新！')
                  break;

                case 'Download.Failed':
                  alert('安装失败')
                  break;

                default:
                  alert('安装已成功，请刷新！');
                  break;
              }
              delete window['expressinstallcallback'];
            };

            var swf = 'expressInstall.swf';
            // insert flash object
            var html = '<object type="application/' +
              'x-shockwave-flash" data="' + swf + '" ';

            if (WebUploader.browser.ie) {
              html += 'classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" ';
            }

            html += 'width="100%" height="100%" style="outline:0">' +
              '<param name="movie" value="' + swf + '" />' +
              '<param name="wmode" value="transparent" />' +
              '<param name="allowscriptaccess" value="always" />' +
              '</object>';

            container.html(html);

          })($wrap);

          // 压根就没有安转。
        } else {
          $wrap.html('<a href="http://www.adobe.com/go/getflashplayer" target="_blank" border="0"><img alt="get flash player" src="http://www.adobe.com/macromedia/style_guide/images/160x41_Get_Flash_Player.jpg" /></a>');
        }

        return;
      } else if (!WebUploader.Uploader.support()) {
        alert('Web Uploader 不支持您的浏览器！');
        return;
      }

      // 实例化
      uploader = WebUploader.create({
        pick: {
          id: '#filePicker-2',
          label: '点击选择图片'
        },
        formData: {
          uid: 123
        },
        dnd: '#dndArea',
        paste: '#uploader',
        swf: 'lib/webuploader/0.1.5/Uploader.swf',
        chunked: false,
        chunkSize: 512 * 1024,
        server: '{:url('api/UploadFiles/uploadAjax')}?file=file&to_dir=goods',
        // runtimeOrder: 'flash',

        // accept: {
        //     title: 'Images',
        //     extensions: 'gif,jpg,jpeg,bmp,png',
        //     mimeTypes: 'image/*'
        // },

        // 禁掉全局的拖拽功能。这样不会出现图片拖进页面的时候，把图片打开。
        disableGlobalDnd: true,
        fileNumLimit: 300,
        fileSizeLimit: 200 * 1024 * 1024, // 200 M
        fileSingleSizeLimit: 50 * 1024 * 1024 // 50 M
      });

      // 拖拽时不接受 js, txt 文件。
      uploader.on('dndAccept', function (items) {
        var denied = false,
          len = items.length,
          i = 0,
          // 修改js类型
          unAllowed = 'text/plain;application/javascript ';

        for (; i < len; i++) {
          // 如果在列表里面
          if (~unAllowed.indexOf(items[i].type)) {
            denied = true;
            break;
          }
        }

        return !denied;
      });

      uploader.on('dialogOpen', function () {
        console.log('here');
      });

      // uploader.on('filesQueued', function() {
      //     uploader.sort(function( a, b ) {
      //         if ( a.name < b.name )
      //           return -1;
      //         if ( a.name > b.name )
      //           return 1;
      //         return 0;
      //     });
      // });

      // 添加“添加文件”的按钮，
      uploader.addButton({
        id: '#filePicker2',
        label: '继续添加'
      });

      uploader.on('ready', function () {
        window.uploader = uploader;
      });

      // 当有文件添加进来时执行，负责view的创建
      function addFile(file) {
        var $li = $('<li id="' + file.id + '">' +
            '<p class="title">' + file.name + '</p>' +
            '<p class="imgWrap"></p>' +
            '<p class="progress"><span></span></p>' +
            '</li>'),

          $btns = $('<div class="file-panel">' +
            '<span class="cancel">删除</span>' +
            '<span class="rotateRight">向右旋转</span>' +
            '<span class="rotateLeft">向左旋转</span></div>').appendTo($li),
          $prgress = $li.find('p.progress span'),
          $wrap = $li.find('p.imgWrap'),
          $info = $('<p class="error"></p>'),

          showError = function (code) {
            switch (code) {
              case 'exceed_size':
                text = '文件大小超出';
                break;

              case 'interrupt':
                text = '上传暂停';
                break;

              default:
                text = '上传失败，请重试';
                break;
            }

            $info.text(text).appendTo($li);
          };

        if (file.getStatus() === 'invalid') {
          showError(file.statusText);
        } else {
          // @todo lazyload
          $wrap.text('预览中');
          uploader.makeThumb(file, function (error, src) {
            var img;

            if (error) {
              $wrap.text('不能预览');
              return;
            }

            if (isSupportBase64) {
              img = $('<img src="' + src + '">');
              $wrap.empty().append(img);
            } else {
              $.ajax('lib/webuploader/0.1.5/server/preview.php', {
                method: 'POST',
                data: src,
                dataType: 'json'
              }).done(function (response) {
                if (response.result) {
                  img = $('<img src="' + response.result + '">');
                  $wrap.empty().append(img);
                } else {
                  $wrap.text("预览出错");
                }
              });
            }
          }, thumbnailWidth, thumbnailHeight);

          percentages[file.id] = [file.size, 0];
          file.rotation = 0;
        }

        file.on('statuschange', function (cur, prev) {
          if (prev === 'progress') {
            $prgress.hide().width(0);
          } else if (prev === 'queued') {
            $li.off('mouseenter mouseleave');
            $btns.remove();
          }

          // 成功
          if (cur === 'error' || cur === 'invalid') {
            console.log(file.statusText);
            showError(file.statusText);
            percentages[file.id][1] = 1;
          } else if (cur === 'interrupt') {
            showError('interrupt');
          } else if (cur === 'queued') {
            percentages[file.id][1] = 0;
          } else if (cur === 'progress') {
            $info.remove();
            $prgress.css('display', 'block');
          } else if (cur === 'complete') {
            $li.append('<span class="success"></span>');
          }

          $li.removeClass('state-' + prev).addClass('state-' + cur);
        });

        $li.on('mouseenter', function () {
          $btns.stop().animate({
            height: 30
          });
        });

        $li.on('mouseleave', function () {
          $btns.stop().animate({
            height: 0
          });
        });

        $btns.on('click', 'span', function () {
          var index = $(this).index(),
            deg;

          switch (index) {
            case 0:
              uploader.removeFile(file);
              return;

            case 1:
              file.rotation += 90;
              break;

            case 2:
              file.rotation -= 90;
              break;
          }

          if (supportTransition) {
            deg = 'rotate(' + file.rotation + 'deg)';
            $wrap.css({
              '-webkit-transform': deg,
              '-mos-transform': deg,
              '-o-transform': deg,
              'transform': deg
            });
          } else {
            $wrap.css('filter', 'progid:DXImageTransform.Microsoft.BasicImage(rotation=' + (~~((file.rotation / 90) % 4 + 4) % 4) + ')');
            // use jquery animate to rotation
            // $({
            //     rotation: rotation
            // }).animate({
            //     rotation: file.rotation
            // }, {
            //     easing: 'linear',
            //     step: function( now ) {
            //         now = now * Math.PI / 180;

            //         var cos = Math.cos( now ),
            //             sin = Math.sin( now );

            //         $wrap.css( 'filter', "progid:DXImageTransform.Microsoft.Matrix(M11=" + cos + ",M12=" + (-sin) + ",M21=" + sin + ",M22=" + cos + ",SizingMethod='auto expand')");
            //     }
            // });
          }


        });

        $li.appendTo($queue);
      }

      // 负责view的销毁
      function removeFile(file) {
        var $li = $('#' + file.id);

        delete percentages[file.id];
        updateTotalProgress();
        $li.off().find('.file-panel').off().end().remove();
      }

      function updateTotalProgress() {
        var loaded = 0,
          total = 0,
          spans = $progress.children(),
          percent;

        $.each(percentages, function (k, v) {
          total += v[0];
          loaded += v[0] * v[1];
        });

        percent = total ? loaded / total : 0;


        spans.eq(0).text(Math.round(percent * 100) + '%');
        spans.eq(1).css('width', Math.round(percent * 100) + '%');
        updateStatus();
      }

      function updateStatus() {
        var text = '',
          stats;

        if (state === 'ready') {
          text = '选中' + fileCount + '张图片，共' +
            WebUploader.formatSize(fileSize) + '。';
        } else if (state === 'confirm') {
          stats = uploader.getStats();
          if (stats.uploadFailNum) {
            text = '已成功上传' + stats.successNum + '张照片至XX相册，' +
              stats.uploadFailNum + '张照片上传失败，<a class="retry" href="#">重新上传</a>失败图片或<a class="ignore" href="#">忽略</a>'
          }

        } else {
          stats = uploader.getStats();
          text = '共' + fileCount + '张（' +
            WebUploader.formatSize(fileSize) +
            '），已上传' + stats.successNum + '张';

          if (stats.uploadFailNum) {
            text += '，失败' + stats.uploadFailNum + '张';
          }
        }

        $info.html(text);
      }

      function setState(val) {
        var file, stats;

        if (val === state) {
          return;
        }

        $upload.removeClass('state-' + state);
        $upload.addClass('state-' + val);
        state = val;

        switch (state) {
          case 'pedding':
            $placeHolder.removeClass('element-invisible');
            $queue.hide();
            $statusBar.addClass('element-invisible');
            uploader.refresh();
            break;

          case 'ready':
            $placeHolder.addClass('element-invisible');
            $('#filePicker2').removeClass('element-invisible');
            $queue.show();
            $statusBar.removeClass('element-invisible');
            uploader.refresh();
            break;

          case 'uploading':
            $('#filePicker2').addClass('element-invisible');
            $progress.show();
            $upload.text('暂停上传');
            break;

          case 'paused':
            $progress.show();
            $upload.text('继续上传');
            break;

          case 'confirm':
            $progress.hide();
            $('#filePicker2').removeClass('element-invisible');
            $upload.text('开始上传');

            stats = uploader.getStats();
            if (stats.successNum && !stats.uploadFailNum) {
              setState('finish');
              return;
            }
            break;
          case 'finish':
            stats = uploader.getStats();
            if (stats.successNum) {
              console.log(stats)
              alert('上传成功');
            } else {
              // 没有成功的图片，重设
              state = 'done';
              location.reload();
            }
            break;
        }

        updateStatus();
      }

      uploader.onUploadProgress = function (file, percentage) {
        var $li = $('#' + file.id),
          $percent = $li.find('.progress span');

        $percent.css('width', percentage * 100 + '%');
        percentages[file.id][1] = percentage;
        updateTotalProgress();
      };

      uploader.onFileQueued = function (file) {
        fileCount++;
        fileSize += file.size;

        if (fileCount === 1) {
          $placeHolder.addClass('element-invisible');
          $statusBar.show();
        }

        addFile(file);
        setState('ready');
        updateTotalProgress();
      };

      uploader.onFileDequeued = function (file) {
        fileCount--;
        fileSize -= file.size;

        if (!fileCount) {
          setState('pedding');
        }

        removeFile(file);
        updateTotalProgress();

      };
      uploader.on('uploadSuccess', function (file, res) {
        console.log(res)
        if(res.code == 1){
          var input = document.createElement('input');
          input.setAttribute('type', 'hidden');
          input.setAttribute('value', res.path);
          input.setAttribute('name', 'goods_images[]');
          $(input).appendTo('.uploader-list-container')
        }
      })
      uploader.on('all', function (type) {
        var stats;
        switch (type) {
          case 'uploadFinished':
            setState('confirm');
            break;

          case 'startUpload':
            setState('uploading');
            break;

          case 'stopUpload':
            setState('paused');
            break;

        }
      });

      uploader.onError = function (code) {
        alert('Eroor: ' + code);
      };

      $upload.on('click', function () {
        if ($(this).hasClass('disabled')) {
          return false;
        }

        if (state === 'ready') {
          uploader.upload();
        } else if (state === 'paused') {
          uploader.upload();
        } else if (state === 'uploading') {
          uploader.stop();
        }
      });

      $info.on('click', '.retry', function () {
        uploader.retry();
      });

      $info.on('click', '.ignore', function () {
        alert('todo');
      });

      $upload.addClass('state-' + state);
      updateTotalProgress();
    });

  })(jQuery);
</script>
</body>

</html>
